name: Deploy AWS Glue Job
on:
  push:
    branches:
      - main
env:
  AWS_REGION: us-east-1
  GLUE_JOB_NAME: mysql-extraction-gh-job
  GLUE_SCRIPT_PATH: s3://nl-aws-de-lab/glue-scripts/mysql_extraction.py
  GITHUB_ACTIONS_ROLE: arn:aws:iam::376873819016:role/github-actions-glue-role
permissions:
  id-token: write
  contents: read
jobs:
  deploy:
    name: Deploy Glue Job
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          pip install awscli boto3 pymysql
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.GITHUB_ACTIONS_ROLE }}
          role-session-name: GitHubActionsGlueDeployment

      - name: Upload script to S3
        run: |
          cd glue-pythonshell
          aws s3 cp mysql_extraction.py s3://nl-aws-de-lab/glue-scripts/

      - name: Run unit tests
        run: |
          cd glue-pythonshell
          python -m unittest discover -s . -p 'test_*.py'

      - name: Create or Update Glue Job
        run: |
          GLUE_EXECUTION_ROLE="arn:aws:iam::376873819016:role/custom-glue-role"
          if aws glue get-job --job-name ${{ env.GLUE_JOB_NAME }} 2>/dev/null; then
            echo "Updating Glue job..."
            aws glue update-job --job-name ${{ env.GLUE_JOB_NAME }} --job-update "{
              \"Role\": \"$GLUE_EXECUTION_ROLE\",
              \"Command\": {
                \"Name\": \"glueetl\",
                \"ScriptLocation\": \"${{ env.GLUE_SCRIPT_PATH }}\",
                \"PythonVersion\": \"3\"
              },
              \"GlueVersion\": \"4.0\",
              \"MaxCapacity\": 1
            }"
          else
            echo "Creating Glue job..."
            aws glue create-job \
              --name ${{ env.GLUE_JOB_NAME }} \
              --role "$GLUE_EXECUTION_ROLE" \
              --command '{"Name":"glueetl", "ScriptLocation":"${{ env.GLUE_SCRIPT_PATH }}", "PythonVersion":"3"}' \
              --glue-version "4.0" \
              --max-capacity 1
          fi
